{% extends "index.html" %}
{% block style%}
<style>
    table{
        border-collapse:initial;
    }
    input{
		width: 200px;
	}
	div{
		padding: 7px;
	}
</style>
{% endblock %}
{% block script%}<script type="text/javascript" src="{{url_for('static', filename='js/db.js')}}"></script>{% endblock %}	
{% block title %}<title>Inventario</title>{% endblock %}
{% block content %}
<div class="grid-container">
    <div class="grid-item">
        <h1>Inventario</h1>
        <button onclick="getAll('/productos/')">General</button>
        <button onclick="getAll('/productos-escuelas/')">Escuelas</button>
        <button onclick="getAll('/productos-compra/')">Compra</button>
        <button onclick="getAll('/productos-other/')">...</button>
        <div>
            <input type="text" id="search_input" style="padding: 5px; width: 550px;" onkeyup="search_table()" placeholder="Buscar">
        </div>
        <div class="inv-table">
            <table id="inv" contenteditable="false">
                <tbody>
    
                </tbody>
            </table>
        </div>
        <p id="tbl_length" style="text-shadow:2px 2px 4px #003153; font-weight: 600;">No. de C칩digos de Barras:</p>
    </div>
    <div>
        
        <div class="grid-item">
            <h1>A침adir Producto</h1>		
            <form id="form-new-product">
                <div><label for="barcode">C칩digo de Barras: </label></div>					
                <div><input id="barcode" type="text" onkeydown="return(event.keyCode!=13);" required></div>	
                <div><label for="_conc">Concepto: </label></div>
                <div><input id="_conc" type="text" onkeydown="return(event.keyCode!=13);" required></div>	
                <div><label for="cu">Precio Unitario: </label></div>					
                <div><input id="cu" type="text" onkeydown="return(event.keyCode!=13);" required></div>
            </form>
            <button onclick="addProduct()">Agregar</button>
        </div>
        <div></div>
        <div class="grid-item">
            <h1>Actualizar Producto</h1>
            <form>
                <div><p id="barcode_update"></p></div>
                <div><p id="barcode_id"></p></div>
                <div><label for="_conc_update">Concepto: </label></div>
                <div><input id="_conc_update" type="text" onkeydown="return(event.keyCode!=13);" required></div>	
                <div><label for="cu_update">Precio Unitario: </label></div>					
                <div><input id="cu_update" type="text" onkeydown="return(event.keyCode!=13);" required></div>
            </form>
            <button onclick="updateDb()">Actualizar</button>
        </div>
    </div>
</div>

<script>
    var urlDB = '';
    window.addEventListener('load', (event) =>{

        document.getElementById('barcode_update').value = "";
        document.getElementById('_conc_update').value = "";
        document.getElementById('cu_update').value = "";

    });

    function getAll(reference){
        urlDB = reference;
        var table = document.getElementById("inv");
        var tablebody = table.getElementsByTagName('tbody')[0];
        if (tablebody.rows.length == 0){
            console.log('Empty Table');
        }else{
            console.log('Cleaning Table')
            tablebody.innerHTML = '';     
        }
        firebase.database().ref(reference).once('value',
            function(AllRecords){
                AllRecords.forEach(
                    function(CurrentRecord){
                        var key = CurrentRecord.key;
                        var name = CurrentRecord.val().name;

                        var price = CurrentRecord.val().price;
                        
                        var n = tablebody.rows.length;
                        var row = tablebody.insertRow(n);

                        var cell1 = row.insertCell(0);
                        var cell2 = row.insertCell(1); 
                        var cell3 = row.insertCell(2);
                        var cell4 = row.insertCell(3);

                        cell1.innerHTML = "<a onclick='selectItem("+n+")'><i class='fas fa-edit'></i></a>";
                        cell2.innerHTML = key;
                        cell3.innerHTML = name;
                        cell4.innerHTML = parseFloat(price).toFixed(2);
                        document.getElementById('tbl_length').innerHTML = 'No. de C칩digos de Barras: ' + String(n + 1);
    
                    }
                );
            }
        );
    }

    function selectItem(n){
        var table = document.getElementById("inv");
        var tablebody = table.getElementsByTagName('tbody')[0];
        document.getElementById('barcode_update').innerHTML = urlDB;
        document.getElementById('barcode_id').innerHTML = tablebody.rows[n].cells[1].innerHTML;
        document.getElementById('_conc_update').value = tablebody.rows[n].cells[2].innerHTML;
        document.getElementById('cu_update').value = tablebody.rows[n].cells[3].innerHTML;
    }

    function updateDb(){
        database = firebase.database();
        var url_code = document.getElementById('barcode_update').innerHTML + document.getElementById('barcode_id').innerHTML;
        var concepto =  document.getElementById('_conc_update').value;
        var price = document.getElementById('cu_update').value;
        console.log(url_code, '+', concepto, '+', price);
        try{
            if (barcode != ""){
                if (concepto !=""){
                    if (price != ""){
                        database.ref(url_code).update({
                            name : concepto,
                            price : price
                        });
                        document.getElementById('barcode_update').value = "";
                        document.getElementById('_conc_update').value = "";
                        document.getElementById('cu_update').value = "";
                        getAll(urlDB)
                    }else{
                        alert('Precio Unitario DEBE de ser llenado')
                    } 
                }else{
                    alert('Concepto DEBE de ser llenado')
                }
            }else{
                alert('Barcode DEBE de ser llenado')
            }
        } catch (error) {
            console.error(error);
            alert("Database Error");
        }
        var input = document.getElementById("search_input");
        input.value = document.getElementById('barcode_id').innerHTML;
        setTimeout(() => { search_table(); }, 1000);
    }

    function search_table(){
        // Declare variables
        var input, filter, table, tr, td, i, txtValue, txtValue2, txtValue3, tablebody;
        input = document.getElementById("search_input");
        filter = input.value.toUpperCase();
        table = document.getElementById("inv");
        tablebody = table.getElementsByTagName('tbody')[0];
        tr = tablebody.getElementsByTagName("tr");

        // Loop through all table rows, and hide those who don't match the search query
        for (i = 0; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td")[1];
            if (td) {
                txtValue = td.textContent || td.innerText;
                txtValue2 = tr[i].getElementsByTagName("td")[2].textContent || tr[i].getElementsByTagName("td")[2].innerText;
                txtValue3 = tr[i].getElementsByTagName("td")[3].textContent || tr[i].getElementsByTagName("td")[3].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                }else if(txtValue2.toUpperCase().indexOf(filter) > - 1){
                    tr[i].style.display = "";
                }else if(txtValue3.toUpperCase().indexOf(filter) > - 1){
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }

    }
</script>
{% endblock %}